buildDir = file(project.projectDir.absolutePath + "/build/")
def odooRepoUrl = "https://github.com/odoo/odoo.git"
def testResourcesDir = file(buildDir.getAbsolutePath()   + "/tests/resources/")
def initzDir = file(project.projectDir.absolutePath + "/" + project.name + "/")

def getVersion = {
  def stdout = new ByteArrayOutputStream()
  exec {
    workingDir project.projectDir.absolutePath + "/" + project.name + "/"
    commandLine 'python', '-c', 'import sys; import ast; file = open("__manifest__.py"); manifest = ast.literal_eval(file.read()); sys.stdout.write(manifest["version"])'
    standardOutput = stdout
  }
  return stdout.toString()
}

project.version = getVersion()

task removeOdoo (type: Exec) {
  commandLine 'docker', 'rm', '-vf', 'dockerfiles_odoo_1'
}

task copyTestResources(type: Copy) {
  from initzDir.getAbsolutePath() + "/tests/resources/"
  into testResourcesDir
  expand(testResources: testResourcesDir.getAbsolutePath(), sources: initzDir.getAbsolutePath())
}

task removeOdooWithCompose (type: Exec) {
  dependsOn copyTestResources
  workingDir testResourcesDir
  commandLine 'docker-compose', '-f', 'dockerfiles/initialize-db.docker-compose.yml', 'down', '-v'
}

task runDbDetached (type: Exec) {
  dependsOn copyTestResources
  workingDir testResourcesDir
  commandLine 'docker-compose', '-f', 'dockerfiles/run-db.docker-compose.yml', 'up', '-d'
}

task initializeDb (type: Exec) {
  dependsOn copyTestResources, runDbDetached
  workingDir testResourcesDir
  commandLine 'docker-compose', '-f', 'dockerfiles/initialize-db.docker-compose.yml', 'up', '--abort-on-container-exit'
}

task runUnitTests (type: Exec) {
  dependsOn initializeDb
  workingDir testResourcesDir
  commandLine 'docker-compose', '-f', 'dockerfiles/run-unit-tests.docker-compose.yml', 'up', '--abort-on-container-exit'
}

task setVolumePermissions (type:Exec) {
  dependsOn runDbDetached
  workingDir testResourcesDir
  commandLine 'docker-compose', '-f', 'dockerfiles/set-volume-permissions.docker-compose.yml', 'up', '--abort-on-container-exit'
}

task installExtras (type: Exec) {
  dependsOn setVolumePermissions
  workingDir testResourcesDir
  commandLine 'docker-compose', '-f', 'dockerfiles/install-extras.docker-compose.yml', 'up', '--abort-on-container-exit'
}

task processCSVs (type: Exec) {
  dependsOn copyTestResources, installExtras
  workingDir testResourcesDir
  commandLine 'docker-compose', '-f', 'dockerfiles/process-csvs.docker-compose.yml', 'up', '--abort-on-container-exit'
}

task runOdoo (type: Exec) {
  dependsOn installExtras
  workingDir testResourcesDir
  commandLine 'docker-compose', '-f', 'dockerfiles/run-with-csvs.docker-compose.yml', 'up', '--abort-on-container-exit'
}

task copySources(type: Copy) {
  from "./" + project.name + "/"
  exclude "tests"
  into "" + buildDir + "/" + project.name + "/"
}

task archiveSources(type: Zip) {
  dependsOn copySources
  archiveBaseName = project.name
  archiveVersion = getVersion()
  from "" + buildDir + "/" +  project.name + "/"
  destinationDirectory = buildDir
}

task test {
  dependsOn runUnitTests, processCSVs
}

task clean {
  dependsOn removeOdooWithCompose
  delete buildDir.getAbsolutePath()
}

task run (type: Exec) {
  dependsOn runOdoo
}

task assemble {
  dependsOn archiveSources
}

task build {
  dependsOn(test, assemble)
}
